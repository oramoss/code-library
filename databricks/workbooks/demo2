// Youtube video: https://www.youtube.com/watch?v=M7t1T1Q5MNc
// Demo of databricks on azure
// Requires a test json file in the relevant azure ADLS2 storage location

// scala!

//Set up some variables...change as necessary
val containerName = "demo"
val storageAccountName = "<< the storage account name>"
val sas = "<<insert SAS token here>>"

val url = "wasbs://" + containerName + "@" + storageAccountName + ".blob.core.windows.net/"
val config = "fs.azure.sas." + containerName + "." + storageAccountName + ".blob.core.windows.net"


//Mount the filesystem
dbutils.fs.mount(
  source = url,
  mountPoint = "/mnt/demo",
  extraConfigs = Map(config -> sas)
  )


//Read the JSON file
val df = spark.read.json("/mnt/demo/json/colours.json")


//Display the content of the JSON file
display(df)


//Select only specific column and display the contents
val specificColumnsDF = df.select("color")
display(specificColumnsDF)


//Rename a column
val renamedColumnsDF = specificColumnsDF.withColumnRenamed("color","colour")
display(renamedColumnsDF)


//Create a view with the renamed column
renamedColumnsDF.createOrReplaceTempView("renamed")


//Select off the view to get an aggregate result
%sql
SELECT colour
,      count(*)
FROM   renamed
GROUP BY colour

//Write the aggregate out to a file on the storage
aggregate.write.mode("overwrite").json("/mnt/demo/json/aggregate.json")

